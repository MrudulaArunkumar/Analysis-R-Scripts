---
title: "Exp1_Online_Analysis"
author: "Mrudula"
date: "21/07/2020"
output: html_document
---

### DATA CLEANING 

The datafiles from 60 participants have been combined together to one file. NOw the datafile needs to be arranged and prepped to set it up for analysis
```{r libraryload, message=FALSE, warning = FALSE}
#loading the necessary libraries
library(tidyverse)
library(plyr)
library(ez)
library(schoRsch)
library(lme4)
library(nlme)
library(data.table)
library(knitr)
library(pander)

#clearing up workspace 
rm(list=ls())

#setting up working directory at home office
#setwd("C:/FSU Jena_PhD/Exp1/Analysis")

#loading the combined datafile
#Exp1data_OL <- read.csv("C:/FSU Jena_PhD/Exp1/Data/Exp1-Prolific/Exp1data_online_fullset.csv")

#Office set up
setwd("D:/PhD/Exp1-Overshadowing/Analysis")
#load from office
Exp1data_OL <- read.csv("D:/PhD/Exp1-Overshadowing/Data/Exp1data_online_fullset.csv")
```
Removing the columns that are not important such as thisN and thisRepN and so on.Next is to split the RT column because each column may contain more than one value and we only need to record the first RT response. RTs should also be changed to numberic as they are represented as strings initially

```{r cleandata}
#removing unnecessary columns

Exp1data_OL <- Exp1data_OL %>%
  select(-Attention.thisRepN,-Attention.thisTrialN,-Attention.thisIndex,-Attention.ran,
         -id, -session, -researcher, -InstRep.thisRepN,-InstRep.thisIndex,-InstRep.thisN, -InstRep.thisTrialN,
         -PracRepeat.thisRepN,-PracRepeat.thisIndex,-PracRepeat.thisN, -PracRepeat.thisTrialN,
         -prctrials.thisIndex,-prctrials.thisRepN,-prctrials.thisTrialN,-prctrials.ran,
         -firstlearntrials.thisN,-firstlearntrials.thisRepN,-firstlearntrials.thisTrialN,-firstlearntrials.ran,-firstlearntrials.thisIndex,
         -afterpause.keys,-blocks.thisRepN,-blocks.thisTrialN,-blocks.thisTrialN,-blocks.thisIndex,-blocks.ran,
         )
#removing the first column named x
Exp1data_OL <- subset(Exp1data_OL, select = -c(X))


#Splitting up the RT column to be able to evaluate the RTs
Exp1data_OL <- separate(Exp1data_OL, col = ResponseKey.rt, into = c("RT_Trials", "RT_secondary"), sep = ",")
#removing the square bracket and changing from string to numeric
Exp1data_OL$RT_Trials <- Exp1data_OL$RT_Trials %>% 
  str_replace_all("\\[|\\]", "")%>%
  as.numeric(Exp1data_OL$RT_Trials)
Exp1data_OL$RT_Trials <- 1000*(Exp1data_OL$RT_Trials)
Exp1data_OL$RT_Trials <- as.integer(Exp1data_OL$RT_Trials)

#making sure screenbg is entered in every cell
Exp1data_OL <- Exp1data_OL%>%group_by(participant)%>%fill(Screen_bg,.direction = "down")

```

##### Data Preparation
Since the data is now cleaned to an extent, next steps involves preparing the df
*Clearly identify the ACC and RT columns
*New column with error rate
*Removing the practice trials - Keep ExpFirst learn and learn trials for previous occurence analysis
*Remove AttentionCheck 
```{r dataprep}
Exp1data_OL$ACC_Trials <- Exp1data_OL$ResponseKey.corr

#new columns for error rate
Exp1data_OL$ErrorRate <- 1 - Exp1data_OL$ACC_Trials
#removing practice trial and attention block 
Exp1data_OL <- Exp1data_OL[!grepl("Practice", Exp1data_OL$Block),]
Exp1data_OL <- Exp1data_OL%>%
  select(-ResponseKey_p.keys,-ResponseKey_p.corr,-ResponseKey_p.rt,-Prac_start.keys,-Prac_start.rt,-pracend.keys,-pracend.rt)
#removing attention check
Exp1data_OL<-Exp1data_OL%>%
  filter(!(Solution %in% c("l", "d")))
#Making sure Experiment unneccessary columns are removed and no NA values are present for ACC and RT
Exp1data_OL<-Exp1data_OL%>%
  select(-InstRep.ran,-consentkey.keys,-consentkey.rt,-beginexp.keys,-beginexp.rt,-checkresp.corr,-checkresp.keys,-checkresp.rt,-Attention.thisN,-Question,-Solution,-gotoPrac.keys,-gotoPrac.rt,-PracRepeat.ran,-prctrials.thisN,-afterpause.rt,-blocks.thisN)

Exp1data_OL<- Exp1data_OL%>%drop_na(RT_Trials)
```

Saving this cleaned and prepared data frame
```{r}
#write.csv(Exp1data_OL, file = "Exp1data_Online_cleaned.csv")
```

### Descriptive Statistics
Below is the summary of the Reaction Time and Accuracy percentage

```{r summarytable}
pander(summary(Exp1data_OL$RT_Trials), style = 'rmarkdown', caption = "Summary of RT")
pander(table(Exp1data_OL$ACC_Trials), style = 'rmarkdown', caption = "Number of correct and Incorrect trials")
pander(round(table(Exp1data_OL$ACC_Trials)/nrow(Exp1data_OL)*100, digits = 3), style = 'rmarkdown', caption = "Percentage of errors")
sum(is.na(Exp1data_OL$RT_Trials))
```

#### Removing Outliers and Farouts
Columns will be created based on the farouts and outliers of the Reaction Time(Only individual based outliers/farouts)
```{r FaroutsOutliers }
#removing RT values for the incorrect trials
Exp1data_OL$RT_Trials[Exp1data_OL$ACC_Trials==0] <- NA
#mean RT for correct trials
pander(summary(Exp1data_OL$RT_Trials), style = 'rmarkdown', caption = "RT summary after removing incorrectTrials")

#plotting the values to check for outliers

ggplot(Exp1data_OL, aes(x=Validity, y=RT_Trials))+
  geom_jitter(aes(color=Validity, fill = Validity), alpha = 0.5)+
  geom_violin(aes(fill=Validity), alpha = 0.8)+
  ggtitle("Overall RT distribution")

#creating function to remove the outliers and farouts
computeTukeys <- function(x){
  P25 <- quantile(x$RT_Trials, .25, na.rm = TRUE, type = 6) #type = 6 -> nimmt SPSS
  P75 <- quantile(x$RT_Trials, .75, na.rm = TRUE, type = 6)
  x$Outlier <- P75 + 1.5*(P75 - P25)
  x$Farouts <- P75 + 3.0*(P75 - P25)
  return(x)
}


#identifying the outliers and farouts at individual level
Exp1data_OL <- ddply(Exp1data_OL, .(participant), computeTukeys)


#creating new column with RT trials after removing outliers/farouts
Exp1data_OL$RT_ifo <- Exp1data_OL$RT_Trials
Exp1data_OL$RT_io <- Exp1data_OL$RT_Trials
Exp1data_OL$RT_ifo[Exp1data_OL$RT_ifo > Exp1data_OL$Farouts|Exp1data_OL$RT_ifo < 300] <- NA
Exp1data_OL$RT_io[Exp1data_OL$RT_io > Exp1data_OL$Outlier|Exp1data_OL$RT_io < 300] <- NA

pander(summary(Exp1data_OL$RT_ifo), style = 'rmarkdown', caption = "Summary of RT after removing Farouts")
pander(summary(Exp1data_OL$RT_io), style = 'rmarkdown', caption = "Summary of RT after removing Outliers")

#Plotting to check farouts
ggplot(Exp1data_OL, aes(x=Validity, y=RT_ifo))+
  geom_jitter(aes(color=Validity, fill = Validity), alpha = 0.5)+
  geom_violin(aes(fill=Validity), alpha = 0.8)+
  ggtitle("RT distribution after the Farouts have been removed")

#plot for outliers
ggplot(Exp1data_OL, aes(x=Validity, y=RT_io))+
  geom_jitter(aes(color=Validity, fill = Validity), alpha = 0.5)+
  geom_violin(aes(fill=Validity), alpha = 0.8)+
  facet_grid(.~Saliency)+
  ggtitle("RT distribution after the outliers have been removed")

```

## Computing Previous Occurence

After identifying Outliers and Farouts, now we move onto identifying the previous or last occurence of a specific Word. How many trials ago was the last time a particular Distractor word appeared?

```{r}
# moving condition to the last column for easy reference
Exp1data_OL <- Exp1data_OL%>%select(-Condition,Condition)
Exp1data_OL <- Exp1data_OL%>%select(-Distractor1,Distractor1)
Exp1data_OL <- Exp1data_OL%>%select(-Distractor2,Distractor2)
```

Now, First step is to add a column that contains the value of how far the previous occurence was. It contains the lag variable. First step is to code the variables where the last occurence was the **immediately** preceding trial(where lag = 1). 

```{r immediatelag}
#For TEST Trials
#Giving a default value of far for the Distance column
Exp1data_OL$Distance <- NA
Exp1data_OL <- Exp1data_OL %>%
  mutate(Distance = ifelse(lag(Condition,1)=="test" & 
              (lag(Distractor1,1)==Distractor1|lag(Distractor1,1)==Distractor2) &
                            lag(participant,1)==participant &
                            lag(ACC_Trials,1)== 1, 1, Distance))
#For LEARN trials 
Exp1data_OL <- Exp1data_OL %>%
  mutate(Distance = ifelse(lag(Condition,1)=="learn" &                           (lag(Distractor1,1)==Distractor1|lag(Distractor1,1)==Distractor2|lag(Distractor2,1)==Distractor1) & lag(participant,1)==participant &  lag(ACC_Trials,1)== 1, 1, Distance))
```
```{r table, results='asis'}
#The number of immediate previous occurences
pander(table(Exp1data_OL$Distance), style = 'rmarkdown', caption = "Table showing the number of immediate previous occurence")
sum(is.na(Exp1data_OL$Distance))


```
This is continued further by adding values for previous occurence that were not the immediately preceding  (eg. n-2, n-3, n-4....)

```{r morelags}
lagvalue <- 2:30

#For learn trials and test trials together

for(j in lagvalue){
  Exp1data_OL <- Exp1data_OL %>% 
    mutate(Distance = ifelse((lag(Condition,j)=="learn"|lag(Condition,j)=="test") &                     (lag(Distractor1,j)==Distractor1|lag(Distractor1,j)==Distractor2|lag(Distractor2,j)==Distractor1) & lag(participant,j)==participant & lag(ACC_Trials,j)== 1 & is.na(Distance)==TRUE, j, Distance))
}

pander(table(Exp1data_OL$Distance), style = 'rmarkdown', caption = "Table showing the number of total previous occurences and how far each of them are")
sum(is.na(Exp1data_OL$Distance))


```
## Previous response 

To check whether the response was repeated or different w.r.t to the previous trial
First, creating another column that contains the values "RR" or "RC" based on whether the response is repeated or changed respectively.
*Using lag function to look back at trials to check whether the response was same or different the last time that occurence happened.
+If for example the previous time Tisch|Kreis occured was a valid test trial 3 rows back where the response expected was "l" then the responsetype column would have the value "RR"

```{r Prevresp}
Exp1data_OL$ResponseType <- NA
#moving this column to the last for easy reference
Exp1data_OL <- Exp1data_OL%>%select(-CorrectAnswer,CorrectAnswer)

#coding repeating the same response and if the conditions are not true the RC is evaluated under the else clause within the main ifelse statement. This was done to avoid revaluating and missing out values that are originally RC but was treated as RR as that was evaluated first.
Rmlag <- 1:30
for(k in Rmlag){
Exp1data_OL <- Exp1data_OL %>% 
  mutate(ResponseType = ifelse((lag(Condition,k)=="learn" | lag(Condition,k)=="test") &          (lag(Distractor1,k)==Distractor1|lag(Distractor1,k)==Distractor2|lag(Distractor2,k)==Distractor1) & lag(participant,k)==participant & lag(CorrectAnswer,k)== CorrectAnswer & is.na(ResponseType)==TRUE, "RR", ifelse((lag(Condition,k)=="learn"|lag(Condition,k)=="test") & (lag(Distractor1,k)==Distractor1|lag(Distractor1,k)==Distractor2|lag(Distractor2,k)==Distractor1)& lag(participant,k)==participant & lag(CorrectAnswer,k)!= CorrectAnswer & is.na(ResponseType)==TRUE, "RC", ResponseType)))
}

pander(table(Exp1data_OL$ResponseType),style = 'rmarkdown', caption = "Total number of RRs and RCs")
sum(is.na(Exp1data_OL$ResponseType))


#crosstable to check factorial combination of Distance x Response Type:
pander(table(Exp1data_OL$Distance, Exp1data_OL$ResponseType), style = 'rmarkdown', caption = 'Factorial combination of Distance x Response Type')

#crosstable to check factorial combination of Distance x Response Type x COndition:
pander(table(Exp1data_OL$Distance, Exp1data_OL$ResponseType, Exp1data_OL$Condition), caption = "Factorial combination of Distance x ResponseType x Condition")


```

## **STATISTICAL ANALYSIS** 

Now for further analysis, the learn trials will be removed and only the test trials will be analysed
```{r}
Exp1data_OL <- Exp1data_OL[!grepl("learn", Exp1data_OL$Condition),]
table(Exp1data_OL$Condition)
```
### Exploratory
```{r}
# Exp1data_explore <- Exp1data_OL[!grepl("1", Exp1data_OL$Distance),]
# Exploreagg <- aggregate(data = Exp1data_explore, RT_ifo~participant+Saliency+Validity, mean)
# #convert to factors for ANOVA
# Exploreagg$participant <- as.factor(Exploreagg$participant)
# Exploreagg$Saliency <- as.factor(Exploreagg$Saliency)
# Exploreagg$Validity <- as.factor(Exploreagg$Validity)
# 
# 
# #aggregate means of farouts
# ExpaggmeanSV_fo <- ezStats(data = Exploreagg,
#                      dv = RT_ifo,
#                      wid = participant,
#                      within = .(Saliency, Validity))

explore_anova_fo <- ezANOVA(Exploreagg,
                    dv = RT_ifo,
                    wid = participant,
                    within = .(Saliency,Validity),
                    detailed = TRUE)
anova_out(explore_anova_fo)

```


#### 1. Aggregate the means with the factors ResponseType, Distance, Saliency, Validity 
Creating a dataframe with the Mean RT across the factors of saliency and validity along with ResponseType and Distance. Separately for farouts and outliers so that it can be distinguised while performaning analysis
```{r aggregate}
#farouts
Exp1agg_fo <- aggregate(data = Exp1data_OL, RT_ifo~participant+Saliency+Validity+ResponseType+Distance, mean)

pander(table(Exp1agg_fo$Distance, Exp1agg_fo$ResponseType),style = 'rmarkdown', caption = "Distance x ResponseType")

#Converting to factors for ANOVA
Exp1agg_fo$participant <- as.factor(Exp1agg_fo$participant)
Exp1agg_fo$Saliency <- as.factor(Exp1agg_fo$Saliency)
Exp1agg_fo$Validity <- as.factor(Exp1agg_fo$Validity)
Exp1agg_fo$ResponseType <- as.factor(Exp1agg_fo$ResponseType)

#aggregate means of farouts
 # aggmeanSV_fo <- ezStats(data = Exp1agg_fo,
 #                      dv = RT_ifo,
 #                      wid = participant,
 #                      within = .(Saliency, Validity,ResponseType))
 # ezDesign(Exp1agg_fo,Validity,Saliency, col=RT_ifo, row = ResponseType)


Exp1agg_o <- aggregate(data = Exp1data_OL, RT_io~participant+Saliency+Validity+ResponseType+Distance, mean)

pander(table(Exp1agg_o$Distance, Exp1agg_o$ResponseType),style = 'rmarkdown', caption = "Distance x ResponseType")

#Converting to factors for ANOVA
Exp1agg_o$participant <- as.factor(Exp1agg_o$participant)
Exp1agg_o$Saliency <- as.factor(Exp1agg_o$Saliency)
Exp1agg_o$Validity <- as.factor(Exp1agg_o$Validity)
Exp1agg_o$ResponseType <- as.factor(Exp1agg_o$ResponseType)

##THROWS ERROR HAVE TO CHECK
#aggregate means of farouts without distance and REsponse Type
# #aggmeanSV_o <- ezStats(data = Exp1agg_o,
#                      dv = RT_io,
#                      wid = participant,
#                      within = .(Saliency, Validity,ResponseType))
```

#### 2. Aggregate means for Standard Analysis : Withouth Response Type and Distance 

Aggregating the measn without the factors or Response Type and Distance to perform basic Standard analysis and check for contingency
```{r}
#farouts
Exp1agg_Standard_fo <- aggregate(data = Exp1data_OL, RT_ifo~participant+Saliency+Validity, mean)
#convert to factors for ANOVA
Exp1agg_Standard_fo$participant <- as.factor(Exp1agg_Standard_fo$participant)
Exp1agg_Standard_fo$Saliency <- as.factor(Exp1agg_Standard_fo$Saliency)
Exp1agg_Standard_fo$Validity <- as.factor(Exp1agg_Standard_fo$Validity)


#aggregate means of farouts
aggmeanSV_fo <- ezStats(data = Exp1agg_Standard_fo,
                     dv = RT_ifo,
                     wid = participant,
                     within = .(Saliency, Validity))

##OUTLIERS
Exp1agg_Standard_o <- aggregate(data = Exp1data_OL, RT_io~participant+Saliency+Validity, mean)

#Converting to factors for ANOVA
Exp1agg_Standard_o$participant <- as.factor(Exp1agg_Standard_o$participant)
Exp1agg_Standard_o$Saliency <- as.factor(Exp1agg_Standard_o$Saliency)
Exp1agg_Standard_o$Validity <- as.factor(Exp1agg_Standard_o$Validity)


#aggregate means of farouts
aggmeanSV_o <- ezStats(data = Exp1agg_Standard_o,
                     dv = RT_io,
                     wid = participant,
                     within = .(Saliency, Validity))

```
##*ANOVA & PLOTS* 

#### 1. Standard Analysis ANOVA with plot
```{r Stdanalysis}
standard_anova_fo <- ezANOVA(Exp1agg_Standard_fo,
                    dv = RT_ifo,
                    wid = participant,
                    within = .(Saliency,Validity),
                    detailed = TRUE)
anova_out(standard_anova_fo)
panderOptions('table.split.table',300)
pander(standard_anova_fo, style = 'rmarkdown', caption = "Standard ANOVA table: RT(farouts) as a function of Saliency and Validity", split.table = Inf)

#outliers
standard_anova_o <- ezANOVA(data = Exp1agg_Standard_o,
                    dv = RT_io,
                    wid = participant,
                    within = .(Saliency,Validity),
                    detailed = TRUE)
anova_out(standard_anova_o)
```
Plots of the data for both outliers and farouts
```{r PlotsafterANOVA}
#Plot for farouts

ggplot(aggmeanSV_fo, aes(x=Saliency, color=Validity, y=Mean))+
  geom_line(aes(group=Validity))+
  geom_point()+
  labs(x="Saliency", y = "ReactionTime")+
  theme_classic()+
  ylim(600,650)+
  ggtitle("Standard Analysis: RT(farouts) as function of saliency and validity")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.title = element_text(size=12), legend.text= element_text(size=10))+
  theme(axis.title = element_text(size=12),axis.text = element_text(size=10))

#plot for outliers

ggplot(aggmeanSV_o, aes(x=Saliency, color=Validity, y=Mean))+
  geom_line(aes(group=Validity))+
  geom_point()+
  labs(x="Saliency", y = "ReactionTime")+
  theme_classic()+
  ylim(600,650)+
  ggtitle("Standard Analysis: RT(Outliers) as function of saliency and validity")+
  theme(plot.title = element_text(hjust = 0.5))+
  theme(legend.title = element_text(size=12), legend.text= element_text(size=10))+
  theme(axis.title = element_text(size=12),axis.text = element_text(size=10))
```

